{% load i18n form_tags widget_tweaks %}

<style type="text/css">@charset "UTF-8";.ng-hide{display:none !important;}ng\:form{display:block;}
</style>
<script type="text/javascript">

/* Remove a choice from collection
 * param (choices array) : choice collection of question
 * param (choice object) : choice object to be removed from collection
 * param (string key) : html element's key
*/
function removeChoice(choices, qcorderIdIn, qorderId, key) {
	if(choices.length>1) {
        var index,ind;
        for(i=0;i<choices.length;i++){			
            if(choices[i].orderId == qcorderIdIn){
                index = i;
                break;
            }

        }
			choices.splice(index,1);        

		// update the position value of choice by starting at "index"
		for(ind=index;ind<choices.length;ind++)
			choices[ind].position=ind+1;	
    
    var elem = document.getElementById(key);
    var parent = elem.parentNode;
    elem.parentNode.removeChild(elem);
        
    // update the Dom elements
    var qcorderId = 1;
    $(parent).children().each(function(){        		
		if($(this).children()[1] && $(this).children()[1].children[0] )	{				
			$(this).attr('id','form-group-question-'+qorderId+'.choice-'+qcorderId);   								
			$(this).children()[0].innerHTML = 'Choice '+qcorderId;    			
			
			$(this).children()[1].children[0].children[0].id = 'fp-id_phases-'+qorderId+'-choice-'+qcorderId+'.answerText';
			$(this).children()[1].children[0].children[0].name = 'question-'+qorderId+'.choice-'+qcorderId+'.answerText';
					
			
			var formkey ='form-group-question-'+qorderId+'.choice-'+qcorderId;
			$(this).children()[1].children[1].children[0].onclick = function(){ removeChoice(choices, qcorderId, qorderId, formkey); };
						
			qcorderId++;
		}
	});

	
	var remvkey = "icon-plus-question-"+qorderId;
    var elem = document.getElementById(remvkey);
	elem.parentNode.removeChild(elem);	
		
	var pluskey= '<div id="icon-plus-question-'+qorderId+'" class="span3">'+
		'<div class="icon-plus-sign icon-2x ng-scope" tooltip="Ajouter un choix" tooltip-trigger="mouseenter" tooltip-placement="left" tooltip-popup-delay="1000" onclick=\'addChoice('+JSON.stringify(choices)+','+qorderId+',"fp-phase-qc-'+qorderId+'")\' tabindex="-1" style="float:left;"></div>'+
		'<div style="clear:both;"></div>'+
	'</div>';

	var d = document.createElement('div');
	d.innerHTML = pluskey;
	
	parent.appendChild(d.firstChild);		
	
}
	
    return false;

};


/* Remove a question from collection
 * param (questions array) : question collection of question
 * param (question object) : question object to be removed from collection
 * param (string key) : html element's key
*/
function removeQuestion(questions,qorderIdIn,key) {

	if(questions.length>1) {
        var index,ind;
        for(i=0;i<questions.length;i++){
            if(questions[i].orderId == qorderIdIn){
                index = i;
                break;
            }
        }

		questions.splice(index,1);
		// update the position value of question by starting at "index"
		for(ind=index;ind<questions.length;ind++)
			questions[ind].position=ind+1;
	}

    var elem = document.getElementById(key);    
    var parent = elem.parentNode;
    elem.parentNode.removeChild(elem);	

    // update the Dom elements
    var qorderId = 1;
    $(parent).children().each(function(){  		
		if($(this).children()[1] && $(this).children()[1].children[0])	{				
			$(this).attr('id','form-group-question-'+qorderId);   		
			
			// Titre - $(this).children()[0]			
			$(this).children()[0].children[0].innerHTML = 'Question '+qorderId;    
								
			$(this).children()[0].children[1].children[0].children[0].id = 'fp-id_phases-'+qorderId+'-questionText';
			$(this).children()[0].children[1].children[0].children[0].name = 'question-'+qorderId+'.questionText';		
			
			var formkey ='form-group-question-'+qorderId;
			$(this).children()[0].children[1].children[1].children[0].onclick = function(){ removeQuestion(questions, qorderId, formkey); };
			
			// Type - $(this).children()[1]					
			$(this).children()[1].children[1].id = 'fp-id_phases-'+qorderId+'-questionType';
			$(this).children()[1].children[1].name = 'question-'+qorderId+'.questionType';	
			
						
			// Mandatory - $(this).children()[2]					
			$(this).children()[2].children[0].children[0].id = 'fp-id_phases-'+qorderId+'-mandatory';
			$(this).children()[2].children[0].children[0].name = 'question-'+qorderId+'.mandatory';		
						
			// Choices - $(this).children()[3]									
			$(this).children()[3].id = 'fp-phase-qc-'+qorderId;
			var node = $(this).children()[3];			
			// update the Dom elements
			var qcorderId = 1;
			var answers = questions[qorderId-1].answers;
			$(node).children().each(function(){						      
				if($(this).children()[1] && $(this).children()[1].children[0])	{							
					$(this).attr('id','form-group-question-'+qorderId+'.choice-'+qcorderId);   							
					$(this).children()[0].innerHTML = 'Choice '+qcorderId;    
					
										
					$(this).children()[1].children[0].children[0].id = 'fp-id_phases-'+qorderId+'-choice-'+qcorderId+'.answerText';
					$(this).children()[1].children[0].children[0].name = 'question-'+qorderId+'.choice-'+qcorderId+'.answerText';
							
					
					var formkey ='form-group-question-'+qorderId+'.choice-'+qcorderId;					
					var orderId = qcorderId;
					var orderIdQ = qorderId;
					$(this).children()[1].children[1].children[0].onclick = function(){ removeChoice(answers, orderId, orderIdQ, formkey); };
					
					qcorderId++;
				}else{
					$(this).attr('id','icon-plus-question-'+qorderId); 		
					var formkey ='fp-phase-qc-'+qorderId;
					var orderId = qorderId;
					$(this).children()[0].onclick = function(){ addChoice(answers, orderId, formkey); };									
				}
			});
			
			qorderId++;
		}
	});

	
	
	var remvkey = "icon-plus-poll";
    var elem = document.getElementById(remvkey);
	elem.parentNode.removeChild(elem);
	
    var pluskey = '<div id="icon-plus-poll" class="span3">'+
            '<div class="btn btn-success ng-binding" onclick=\'addQuestion('+JSON.stringify(questions)+',"fp-phase-2")\' tabindex="-1"><i class="icon-plus"></i>&nbsp;Add a question</div>'+
            '<div style="clear:both;"></div>'+
        '</div>';
		
	
	var d = document.createElement('div');
	d.innerHTML = pluskey;
	
	parent.appendChild(d.firstChild);		

    return false;
};



/* Add a choice to collection
 * param (choices array) : choice collection of question
 * param (int questionPos) : position of the question
 * param (string key) : html element's key
*/
function addChoice(choices,questionPos, key) {
    var choice;
	if (choices[choices.length-1].freetextAnswer) {
	    choice = {"answerText":"","orderId":choices.length,"mediaURL":"","freetextAnswer":false};
		choices.splice(length-1, 0, choice);
	}else {
	    choice = {"answerText":"","orderId":choices.length+1,"mediaURL":"","freetextAnswer":false};
		choices.push(choice);
	}

    // Remove the button
    var remvkey = "icon-plus-question-"+questionPos;
    var elem = document.getElementById(remvkey);
	var parent = elem.parentNode;
    parent.removeChild(elem);

    var choiceKey = '<div id="form-group-question-'+questionPos+'.choice-'+choice.orderId+'" class="form-group">'+
            '<label>'+
                'Choice '+choice.orderId+
                '<br>'+
            '</label>'+
            '<div style="position:relative;">'+
                '<div style="margin-right: 44px;">'+
                    '<input class="form-control choice" id="fp-id_phases-'+questionPos+'-choice-'+choice.orderId+'.answerText" maxlength="80" name="question-'+questionPos+'.choice-'+choice.orderId+'.answerText" type="text" value="" />'+
                '</div>'+
                '<div style="width: 39px;position:absolute;right:0;height:100%;top:0;">'+
                    '<i class="icon-remove-sign icon-2x ng-scope" tooltip="Supprimer" tooltip-trigger="mouseenter" tooltip-placement="left" tooltip-popup-delay="1000" onclick=\'removeChoice('+JSON.stringify(choices)+','+choice.orderId+','+questionPos+',"form-group-question-'+questionPos+'.choice-'+choice.orderId+'")\' ng-disabled="question.questionChoices.length<=2" tabindex="-1" disabled="disabled"></i>'+
                '</div>'+
            '</div>'+
        '</div>';

    var choiceKey2 = '<div id="icon-plus-question-'+questionPos+'" class="span3">'+
			'<div class="icon-plus-sign icon-2x ng-scope" tooltip="Ajouter un choix" tooltip-trigger="mouseenter" tooltip-placement="left" tooltip-popup-delay="1000" onclick=\'addChoice('+JSON.stringify(choices)+','+questionPos+',"fp-phase-qc-'+questionPos+'")\' tabindex="-1" style="float:left;"></div>'+
			'<div style="clear:both;"></div>'+
		'</div>';
		
	var d = document.createElement('div');
	d.innerHTML = choiceKey;
	
	var d2 = document.createElement('div');
	d2.innerHTML = choiceKey2;
	
	document.getElementById(key).appendChild(d.firstChild);
	document.getElementById(key).appendChild(d2.firstChild);	
	// Reorder
    // update the Dom elements
    var qcorderId = 1;
	var qorderId = questionPos;
    $(parent).children().each(function(){        		
		if($(this).children()[1] && $(this).children()[1].children[0])	{	
			$(this).attr('id','form-group-question-'+qorderId+'.choice-'+qcorderId);   					
			$(this).children()[0].innerHTML = 'Choice '+qcorderId;    
					
			
			$(this).children()[1].children[0].children[0].id = 'fp-id_phases-'+qorderId+'-choice-'+qcorderId+'.answerText';
			$(this).children()[1].children[0].children[0].name = 'question-'+qorderId+'.choice-'+qcorderId+'.answerText';
					
			
			var formkey ='form-group-question-'+qorderId+'.choice-'+qcorderId;
			$(this).children()[1].children[1].children[0].onclick = function(){ removeChoice(choices, qcorderId, qorderId, formkey); };
						
			qcorderId++;
		}
	});
};



/* Add a question to collection
 * param (questions array) : choice collection of question
 * param ($event object) : event object
*/
function addQuestion(questions, key) {
    if(!questions){
        var questions = [];
    }
    var question = {"questionText":"","orderId":questions.length+1,"questionType":"CHECKBOX","mandatory":true,"mediaURLs":[""],"answers":[{"answerText":"","orderId":1,"mediaURL":"","freetextAnswer":false},{"answerText":"","orderId":2,"mediaURL":"","freetextAnswer":false}]};
	questions.push(question);

    // Remove the button
    var remvkey = "icon-plus-poll";
    var elem = document.getElementById(remvkey);
	var parent = elem.parentNode;
    parent.removeChild(elem);
	
	var questionKey ='<div id="form-group-question-'+question.orderId+'">'+
        '<div class="form-group">'+
            '<label>'+
                'Question '+question.orderId+
                '<br>'+
            '</label>'+
            '<div style="position:relative;">'+
                '<div style="margin-right: 44px;">'+
                   '<input class="form-control choice" id="fp-id_phases-'+question.orderId+'-questionText" maxlength="80" name="question-'+question.orderId+'.questionText" type="text" value="" />'+
                '</div>'+
                '<div style="width: 39px;position:absolute;right:0;height:100%;top:0;">'+
                    '<i class="icon-trash icon-2x ng-scope" tooltip="Supprimer" tooltip-popup-delay="1000" tooltip-trigger="mouseenter" tooltip-placement="left" onclick=\'removeQuestion('+JSON.stringify(questions)+','+question.orderId+', "form-group-question-'+question.orderId+'")\' tabindex="-1"></i>'+
                '</div>'+
            '</div>'+
        '</div>'+
        '<div class="form-group">'+
            '<label>'+
                'Type'+
                '<br>'+
            '</label>'+
            '<select class="form-control select" id="fp-id_phases-'+question.orderId+'-questionType" name="question-'+question.orderId+'.questionType"  onchange=\'changeType(this.options[this.selectedIndex].value, "fp-phase-qc-'+question.orderId+'", '+question.orderId+')\' >'+
                '<option value="CHECKBOX"  selected>MULTIPLE</option>'+
                '<option value="RADIO" >SINGLE</option>'+
                '<option value="FREETEXT" >OPEN</option>'+
                '<option value="ORDER"  >RANKING</option>'+
            '</select>'+
        '</div>'+
        '<div class="form-group ">'+
            '<label>'+
                '<input id="fp-id_phases-'+question.orderId+'-mandatory" name="question-'+question.orderId+'.mandatory" type="checkbox" value="" checked="checked" />'+
                'Mandatory'+
                '<br>'+
            '</label>'+
        '</div>'+
		'<div id="fp-phase-qc-'+question.orderId+'">';
        for(ind=0;ind<question.answers.length;ind++){
            answer = question.answers[ind];
            questionKey = questionKey +'<div id="form-group-question-'+question.orderId+'.choice-'+answer.orderId+'" class="form-group">'+
                '<label>'+
                    'Choice '+answer.orderId+
                    '<br>'+
                '</label>'+
                '<div style="position:relative;">'+
                    '<div style="margin-right: 44px;">'+
                        '<input class="form-control choice" id="fp-id_phases-'+question.orderId+'-choice-'+answer.orderId+'.answerText" maxlength="80" name="question-'+question.orderId+'.choice-'+answer.orderId+'.answerText" type="text" value="" //>'+
                    '</div>'+
                    '<div style="width: 39px;position:absolute;right:0;height:100%;top:0;">'+
                        '<i class="icon-remove-sign icon-2x ng-scope" tooltip="Supprimer" tooltip-trigger="mouseenter" tooltip-placement="left" tooltip-popup-delay="1000" onclick=\'removeChoice('+JSON.stringify(question.answers)+','+answer.orderId+','+question.orderId+', "form-group-question-'+question.orderId+'.choice-'+answer.orderId+'")\' ng-disabled="question.questionChoices.length<=2" tabindex="-1" disabled="disabled"></i>'+
                    '</div>'+
                    '</div>'+
                '</div>';

                if (answer.orderId == question.answers.length){
                    questionKey = questionKey +
                    '<div id="icon-plus-question-'+question.orderId+'" class="span3">'+
                        '<div class="icon-plus-sign icon-2x ng-scope" tooltip="Ajouter un choix" tooltip-trigger="mouseenter" tooltip-placement="left" tooltip-popup-delay="1000" onclick=\'addChoice('+JSON.stringify(question.answers)+','+question.orderId+', "fp-phase-qc-'+question.orderId+'")\' tabindex="-1" style="float:left;"></div>'+
                        '<div style="clear:both;"></div>'+
                    '</div>';
                }            
        }

    questionKey = questionKey +'</div>'+
				'</div>';

    questionKey1 = '<div id="icon-plus-poll" class="span3">'+
            '<div class="btn btn-success ng-binding" onclick=\'addQuestion('+JSON.stringify(questions)+',"fp-phase-2")\' tabindex="-1"><i class="icon-plus"></i>&nbsp;Add a question</div>'+
            '<div style="clear:both;"></div>'+
        '</div>';
		
	var d = document.createElement('div');
	d.innerHTML = questionKey;

	var d1 = document.createElement('div');
	d1.innerHTML = questionKey1;
	
	document.getElementById(key).appendChild(d.firstChild);
	document.getElementById(key).appendChild(d1.firstChild);	
	
	var parent = document.getElementById(key);
	
    // update the Dom elements
    var qorderId = 1;	
    $(parent).children().each(function(){  		
		if($(this).children()[1] && $(this).children()[1].children[0])	{				
			$(this).attr('id','form-group-question-'+qorderId);   		
			
			// Titre - $(this).children()[0]			
			$(this).children()[0].children[0].innerHTML = 'Question '+qorderId;    					
			$(this).children()[0].children[1].children[0].children[0].id = 'fp-id_phases-'+qorderId+'-questionText';
			$(this).children()[0].children[1].children[0].children[0].name = 'question-'+qorderId+'.questionText';		
			
			var formkey ='form-group-question-'+qorderId;
			$(this).children()[0].children[1].children[1].children[0].onclick = function(){ removeQuestion(questions, qorderId, formkey); };
			
			// Type - $(this).children()[1]					
			$(this).children()[1].children[1].id = 'fp-id_phases-'+qorderId+'-questionType';
			$(this).children()[1].children[1].name = 'question-'+qorderId+'.questionType';	
			
						
			// Mandatory - $(this).children()[2]					
			$(this).children()[2].children[0].children[0].id = 'fp-id_phases-'+qorderId+'-mandatory';
			$(this).children()[2].children[0].children[0].name = 'question-'+qorderId+'.mandatory';		
						
			// Choices - $(this).children()[3]									
			$(this).children()[3].id = 'fp-phase-qc-'+qorderId;
			var node = $(this).children()[3];			
			// update the Dom elements
			var qcorderId = 1;
			var answers = questions[qorderId-1].answers;
			$(node).children().each(function(){		      	
				if($(this).children()[1] && $(this).children()[1].children[0])	{		
					$(this).attr('id','form-group-question-'+qorderId+'.choice-'+qcorderId);   		
					$(this).children()[0].innerHTML = 'Choice '+qcorderId;    
										
					$(this).children()[1].children[0].children[0].id = 'fp-id_phases-'+qorderId+'-choice-'+qcorderId+'.answerText';
					$(this).children()[1].children[0].children[0].name = 'question-'+qorderId+'.choice-'+qcorderId+'.answerText';
							
					
					var formkey ='form-group-question-'+qorderId+'.choice-'+qcorderId;
					var orderId = qcorderId; 	
					var orderIdQ = qorderId;					
					$(this).children()[1].children[1].children[0].onclick = function(){ removeChoice(answers, orderId, orderIdQ, formkey); };
					
					qcorderId++;
				}else{
					$(this).attr('id','icon-plus-question-'+qorderId); 		
					var formkey ='fp-phase-qc-'+qorderId;
					var orderId = qorderId;
					$(this).children()[0].onclick = function(){ addChoice(answers, orderId, formkey); };								
				}
			});
			
			qorderId++;
		}
	});
	

};

/* Update the appearance of question when the question type is changed
*/
function changeType(questionType, key, qorderId) { 
    var elem = document.getElementById(key);	    
	if(questionType === 'FREETEXT') {
			$(elem).children().each(function(){		
                elem.removeChild(this);                
			});                      
	}else {        
		if($(elem).children().length == 0){
            var question = {"questionText":"","orderId":qorderId,"questionType":"CHECKBOX","mandatory":true,"mediaURLs":[""],"answers":[{"answerText":"","orderId":1,"mediaURL":"","freetextAnswer":false},{"answerText":"","orderId":2,"mediaURL":"","freetextAnswer":false}]};
            var questionKey="";
                for(ind=0;ind<question.answers.length;ind++){
                    answer = question.answers[ind];
                    questionKey = '<div id="form-group-question-'+question.orderId+'.choice-'+answer.orderId+'" class="form-group">'+
                        '<label>'+
                            'Choice '+answer.orderId+
                            '<br>'+
                        '</label>'+
                        '<div style="position:relative;">'+
                            '<div style="margin-right: 44px;">'+
                                '<input class="form-control choice" id="fp-id_phases-'+question.orderId+'-choice-'+answer.orderId+'.answerText" maxlength="80" name="question-'+question.orderId+'.choice-'+answer.orderId+'.answerText" type="text" value="" //>'+
                            '</div>'+
                            '<div style="width: 39px;position:absolute;right:0;height:100%;top:0;">'+
                                '<i class="icon-remove-sign icon-2x ng-scope" tooltip="Supprimer" tooltip-trigger="mouseenter" tooltip-placement="left" tooltip-popup-delay="1000" onclick=\'removeChoice('+JSON.stringify(question.answers)+','+answer.orderId+','+question.orderId+', "form-group-question-'+question.orderId+'.choice-'+answer.orderId+'")\' ng-disabled="question.questionChoices.length<=2" tabindex="-1" disabled="disabled"></i>'+
                            '</div>'+
                            '</div>'+
                        '</div>';
                        
                        var d = document.createElement('div');
                        d.innerHTML = questionKey;
                        document.getElementById(key).appendChild(d.firstChild);  
                
                        if (answer.orderId == question.answers.length){
                            questionKey ='<div id="icon-plus-question-'+question.orderId+'" class="span3">'+
                                '<div class="icon-plus-sign icon-2x ng-scope" tooltip="Ajouter un choix" tooltip-trigger="mouseenter" tooltip-placement="left" tooltip-popup-delay="1000" onclick=\'addChoice('+JSON.stringify(question.answers)+','+question.orderId+', "fp-phase-qc-'+question.orderId+'")\' tabindex="-1" style="float:left;"></div>'+
                                '<div style="clear:both;"></div>'+
                            '</div>';                            
                            var d = document.createElement('div');
                            d.innerHTML = questionKey;
                            document.getElementById(key).appendChild(d.firstChild);  
                
                        }            
                }                 
        }       
    }
}
</script>

<script type="text/javascript" charset="UTF-8" src="http://maps.googleapis.com/maps/api/js?v=3&sensor=true&amp;libraries=drawing"></script>
<script type="text/javascript">
      var map;
      var drawingManager;
      var selectedShape;
      var colors = ['#1E90FF', '#FF1493', '#32CD32', '#FF8C00', '#4B0082'];
      var selectedColor;
      var colorButtons = {};
	  var geocoder = new google.maps.Geocoder();
      var defaultLatLng = new google.maps.LatLng(52.520, 13.404);

      function clearSelection() {
        if (selectedShape) {
          selectedShape.setEditable(false);
          selectedShape = null;
        }
      }

      function setSelection(shape) {
        clearSelection();
        selectedShape = shape;
        shape.setEditable(true);
        selectColor(shape.get('fillColor') || shape.get('strokeColor'));
      }

      function deleteSelectedShape() {
        if (selectedShape) {
          selectedShape.setMap(null);
        }
        // To show:
         drawingManager.setOptions({
           drawingControl: true
         });
      }

      function selectColor(color) {
        selectedColor = color;
        for (var i = 0; i < colors.length; ++i) {
          var currColor = colors[i];
          colorButtons[currColor].style.border = currColor == color ? '2px solid #789' : '2px solid #fff';
        }

        // Retrieves the current options from the drawing manager and replaces the
        // stroke or fill color as appropriate.
        var polylineOptions = drawingManager.get('polylineOptions');
        polylineOptions.strokeColor = color;
        drawingManager.set('polylineOptions', polylineOptions);

        var rectangleOptions = drawingManager.get('rectangleOptions');
        rectangleOptions.fillColor = color;
        drawingManager.set('rectangleOptions', rectangleOptions);

        var circleOptions = drawingManager.get('circleOptions');
        circleOptions.fillColor = color;
        drawingManager.set('circleOptions', circleOptions);

        var polygonOptions = drawingManager.get('polygonOptions');
        polygonOptions.fillColor = color;
        drawingManager.set('polygonOptions', polygonOptions);
      }

      function setSelectedShapeColor(color) {
        if (selectedShape) {
          if (selectedShape.type == google.maps.drawing.OverlayType.POLYLINE) {
            selectedShape.set('strokeColor', color);
          } else {
            selectedShape.set('fillColor', color);
          }
        }
      }

      function makeColorButton(color) {
        var button = document.createElement('span');
        button.className = 'color-button';
        button.style.backgroundColor = color;
        google.maps.event.addDomListener(button, 'click', function() {
          selectColor(color);
          setSelectedShapeColor(color);
        });

        return button;
      }

       function buildColorPalette() {
         var colorPalette = document.getElementById('color-palette');
         for (var i = 0; i < colors.length; ++i) {
           var currColor = colors[i];
           var colorButton = makeColorButton(currColor);
           colorPalette.appendChild(colorButton);
           colorButtons[currColor] = colorButton;
         }
         selectColor(colors[0]);
       }

	function setFocusByLabel(label, map) {
			geocoder.geocode( { 'address': label }, function(results, status) {
		    if (status == google.maps.GeocoderStatus.OK) {
		        map.setCenter(results[0].geometry.location);
		    } else {
		       // notificationServices.addMsg("location","draw",404);
		    }
		});
	}


	/* create a location with the supplied infomation and do clean after receiving the request response
	*/
	function create_location (){
        wktFormat = trans_to_wkt(selectedShape.getPath().b);        
        selectedShape.setMap(null);
        drawLocation(wktFormat);

        // Editing geolocation field
        var elem = document.getElementById("geofenceLocation");
        elem.parentNode.removeChild(elem);

        geofenceKey = '<input type="hidden" id="geofenceLocation" name="geofenceLocation" value="'+wktFormat+'""/>';
        document.getElementById("field-hide").innerHTML += geofenceKey;

	}

	/* draw a location at the map and center the map by its geographic coordinates
	 * param (location : object) : the location object
	*/
	function drawLocation(location) {	
		var center = drawPolygon(location)[0];

		if(center.lat() && center.lng()) {
			map.setCenter(center);
		}else {			
            map.setCenter(defaultLatLng);
		}
	}


	function drawPolygon(wktFormat) {    
		var polygon = trans_to_array(wktFormat);

	    selectedShape = new google.maps.Polygon({
			paths: polygon,
			strokeColor: colors[0],
			strokeOpacity: 0.6,
			strokeWeight: 0,
			fillColor: colors[0],
			fillOpacity: 0.45,
			editable: true
	    });



	    selectedShape.setMap(map);

	    return polygon;
	}


	function trans_to_wkt(paths) {

		var res = "POLYGON((";
		for (var j = 0; j < paths.length; j++) {
			res = res + paths[j].lng() + " " + paths[j].lat() + ","
		};
		res = res + paths[0].lng() + " " + paths[0].lat() + "))";
		return res;
	}

	function trans_to_array(wkt){
  		//initialize wkt-textarea-input
	  	var res = [], coors;

	  	var input_cache = wkt.replace('POLYGON((','');
	  	input_cache = input_cache.replace('))','');

	  	var input_array = input_cache.split(',')

	  	for (var j = 0; j < input_array.length - 1; j++) {
	  		coors = input_array[j].split(" ");
	  		res.push(new google.maps.LatLng(parseFloat(coors[1]), parseFloat(coors[0])));
	  	}

	  	return res;
  	}


      function initialize() {        
        map = new google.maps.Map(document.getElementById('map'), {
          zoom: 10,
          center: new google.maps.LatLng(22.344, 114.048),
          mapTypeId: google.maps.MapTypeId.ROADMAP,
          disableDefaultUI: true,
          zoomControl: true
        });

        $('.tabs a[href="#participation"]').click(function(){
           $(this).tab('show');           
           initialize();
        });        
        
        var polyOptions = {
          strokeWeight: 0,
          fillOpacity: 0.45,
          editable: true
        };
        // Creates a drawing manager attached to the map that allows the user to draw
        // markers, lines, and shapes.
        drawingManager = new google.maps.drawing.DrawingManager({
          drawingMode: google.maps.drawing.OverlayType.POLYGON,
          drawingControlOptions: {
            drawingModes: [
              google.maps.drawing.OverlayType.POLYGON
            ]
          },
          markerOptions: {
            draggable: true
          },
          polylineOptions: {
            editable: true
          },
          rectangleOptions: polyOptions,
          circleOptions: polyOptions,
          polygonOptions: polyOptions,
          map: map
        });

        google.maps.event.addListener(drawingManager, 'overlaycomplete', function(event) {
          if (event.type == google.maps.drawing.OverlayType.CIRCLE) {
            var radius = event.overlay.getRadius();
          }
        });
        google.maps.event.addListener(drawingManager, 'overlaycomplete', function(e) {
            if (e.type != google.maps.drawing.OverlayType.MARKER) {
            // Switch back to non-drawing mode after drawing a shape.
            drawingManager.setDrawingMode(null);
            // To hide:
            drawingManager.setOptions({
              drawingControl: false
            });

            // Add an event listener that selects the newly-drawn shape when the user
            // mouses down on it.
            var newShape = e.overlay;
            newShape.type = e.type;
            google.maps.event.addListener(newShape, 'click', function() {
              setSelection(newShape);
            });
            setSelection(newShape);
            create_location ();
          }
        });

        var geofenceLocation = '{{poll.geofenceLocation}}';
        if(!geofenceLocation){
		    //setFocusByLabel("Berlin", map);
            map.setCenter(defaultLatLng);
		}else{
		    drawLocation(geofenceLocation);
            //var newShape = geofenceLocation;
            //newShape.type = "poly";
           // setSelection(newShape);
		}

		//setFocusByLabel("Berlin", map);
        // Clear the current selection when the drawing mode is changed, or when the
        // map is clicked.
        google.maps.event.addListener(drawingManager, 'drawingmode_changed', clearSelection);
        google.maps.event.addListener(map, 'click', clearSelection);
        google.maps.event.addDomListener(document.getElementById('delete-button'), 'click', deleteSelectedShape);

        buildColorPalette();
      }
      google.maps.event.addDomListener(window, 'load', initialize);
    </script>


<style type="text/css">
    #map, html, body {
    padding: 0;
    margin: 0;
    height: 100%;
    }

    #panel {
    width: 200px;
    font-family: Arial, sans-serif;
    font-size: 13px;
    float: right;
    margin: 10px;
    }

    #color-palette {
    clear: both;
    }

    .color-button {
    display: none;
    width: 14px;
    height: 14px;
    font-size: 0;
    margin: 2px;
    float: left;
    cursor: pointer;
    }

    #delete-button {
    margin-top: 5px;
    }
</style>

<style type="text/css">.gm-style .gm-style-cc span,.gm-style .gm-style-cc a,.gm-style .gm-style-mtc div{font-size:10px}</style><style type="text/css">@media print {  .gm-style .gmnoprint, .gmnoprint {    display:none  }}@media screen {  .gm-style .gmnoscreen, .gmnoscreen {    display:none  }}</style><style type="text/css">.gm-style-pbc{transition:opacity ease-in-out;background-color:rgba(0,0,0,0.45);text-align:center}.gm-style-pbt{font-size:22px;color:white;font-family:Roboto,Arial,sans-serif;position:relative;margin:0;top:50%;-webkit-transform:translateY(-50%);-ms-transform:translateY(-50%);transform:translateY(-50%)}</style><style type="text/css">.gm-style{font-family:Roboto,Arial,sans-serif;font-size:11px;font-weight:400;text-decoration:none}.gm-style img{max-width:none}</style>
<!--Description section -->
<div class="phase-form">
    <h5>
        <a href="#fp-phase-1"  class="collapse collapsed" data-toggle="collapse" aria-expanded="false">
            Poll: Description            
            <i class="fa fa-chevron-up pull-right"></i>
        </a>
    </h5>

    <div class="single-phase collapse" id="fp-phase-1" aria-expanded="false" style="height: 0px;">
        <div class="form-group ">
            <label>
                Title
                <br>
            </label>
            <input class="form-control" id="fp-id_phases-0-title" maxlength="80" name="title" type="text" value="{{poll.title}}" />

        </div>
        <div class="form-group ">
            <label>
                Subtitle
                <br>
            </label>
            <textarea class="form-control" cols="40" id="fp-id_phases-0-shortDescription" maxlength="300" name="shortDescription" rows="10">{{poll.shortDescription}}</textarea>
        </div>

        <div class="form-group ">
            <label>
                Long description
                <br>
            </label>
            <textarea class="form-control" cols="40" id="fp-id_phases-0-longDescription" maxlength="300" name="longDescription" rows="10">{{poll.longDescription}}</textarea>

        </div>
        <div class="form-group ">
            <label>
                Conclude message
                <br>
            </label>
            <input class="form-control" id="fp-id_phases-0-concludeMessage" maxlength="80" name="concludeMessage" type="text" value="{{poll.concludeMessage}}" />

        </div>
    </div>
</div>


<!-- Questions section -->
<div class="phase-form">
    <h5>
        <a href="#fp-phase-2" class="collapse collapsed" data-toggle="collapse" aria-expanded="false">
            Poll: Questions
            <i class="fa fa-chevron-up pull-right"></i>
        </a>
    </h5>

    <div class="single-phase collapse" id="fp-phase-2" aria-expanded="false" style="height: 0px;">
    {% for question in poll.questions %}
        <div id="form-group-question-{{question.orderId}}">
        <div class="form-group">
            <label>
                Question {{question.orderId}}
                <br>
            </label>
            <div style="position:relative;">
                <div style="margin-right: 44px;">
                    <input class="form-control choice" id="fp-id_phases-{{question.orderId}}-questionText" maxlength="80" name="question-{{question.orderId}}.questionText" type="text" value="{{question.questionText}}" />
                </div>
                <div style="width: 39px;position:absolute;right:0;height:100%;top:0;">
                    <i class="icon-trash icon-2x ng-scope" tooltip="Supprimer" tooltip-popup-delay="1000" tooltip-trigger="mouseenter" tooltip-placement="left" onclick='removeQuestion({{questions|get_simplejson }},{{question.orderId}}, "form-group-question-{{question.orderId}}")' tabindex="-1"></i>
                </div>
            </div>

        </div>
        <div class="form-group">
            <label>
                Type
                <br>
            </label>
            <!--<div class="form-control">-->
            <select class="form-control select" id="fp-id_phases-{{question.orderId}}-questionType" name="question-{{question.orderId}}.questionType" onchange='changeType(this.options[this.selectedIndex].value, "fp-phase-qc-{{question.orderId}}", {{question.orderId}})' >
                <option value="CHECKBOX"  {% if question.questionType == 'CHECKBOX' %}selected{% endif %}>MULTIPLE</option>
                <option value="RADIO"  {% if question.questionType == 'RADIO' %}selected{% endif %}>SINGLE</option>
                <option value="FREETEXT"  {% if question.questionType == 'FREETEXT' %}selected{% endif %}>OPEN</option>
                <option value="ORDER"  {% if question.questionType == 'ORDER' %}selected{% endif %}>RANKING</option>
            </select>
            <!--</div>-->
        </div>

        <div class="form-group ">
            <label>
                <input id="fp-id_phases-{{question.orderId}}-mandatory" name="question-{{question.orderId}}.mandatory" type="checkbox" value="" {% if question.mandatory == True %} checked="checked" {% endif %} />
                Mandatory
                <br>
            </label>
        </div>

        <div id="fp-phase-qc-{{question.orderId}}">
			{% for answer in question.answers %}
			<div id="form-group-question-{{question.orderId}}.choice-{{answer.orderId}}" class="form-group">            
				<label>
					Choice {{answer.orderId}}
					<br>
				</label>

				<div style="position:relative;">
					<div style="margin-right: 44px;">
						<input class="form-control choice" id="fp-id_phases-{{question.orderId}}-choice-{{answer.orderId}}.answerText" maxlength="80" name="question-{{question.orderId}}.choice-{{answer.orderId}}.answerText" type="text" value="{{answer.answerText}}" />
					</div>
					<div style="width: 39px;position:absolute;right:0;height:100%;top:0;">
						<i class="icon-remove-sign icon-2x ng-scope" tooltip="Supprimer" tooltip-trigger="mouseenter" tooltip-placement="left" tooltip-popup-delay="1000" onclick='removeChoice({{question.answers|get_simplejson }},{{answer.orderId}}, {{question.orderId}}, "form-group-question-{{question.orderId}}.choice-{{answer.orderId}}")' ng-disabled="question.questionChoices.length<=2" tabindex="-1" disabled="disabled" >	</i>
					</div>
				</div>	
			</div>
			
            {% if answer.orderId == question.answers|length  %}
            <div id="icon-plus-question-{{question.orderId}}" class="span3">
                <div class="icon-plus-sign icon-2x ng-scope" tooltip="Ajouter un choix" tooltip-trigger="mouseenter" tooltip-placement="left" tooltip-popup-delay="1000" onclick='addChoice({{question.answers|get_simplejson }},{{question.orderId}}, "fp-phase-qc-{{question.orderId}}")' tabindex="-1" style="float:left;"></div>
                <div style="clear:both;"></div>
            </div>
            {% endif %}			
			{% endfor %}								
		</div>   		
		</div>	
        {% if question.orderId == poll.questions|length  %}
        <div id="icon-plus-poll" class="span3">
            <div class="btn btn-success ng-binding" onclick='addQuestion({{poll.questions|get_simplejson}},"fp-phase-2")' tabindex="-1"><i class="icon-plus"></i>&nbsp;Add a question</div>
            <div style="clear:both;"></div>
        </div>     
        {% endif %}
    {% endfor %}     
	</div>
</div>



<!--Location section -->
<div class="phase-form">
    <h5>
        <a href="#fp-phase-3" class="collapse collapsed" data-toggle="collapse">
            Poll: Location
            <i class="fa fa-chevron-up pull-right"></i>
        </a>
    </h5>

    <div class="single-phase collapse in" id="fp-phase-3">

        <div class="form-group ">
            <div id="panel">
                <div id="color-palette"><span class="color-button" style="background-color: rgb(30, 144, 255); border: 2px solid rgb(119, 136, 153);"></span></div>
                <div>
                </div>
            </div>

            <div class="row-fluid" style="margin-bottom:5px;">
                <div id="map" style="width: 100%; height: 399px; position: relative; overflow: hidden;"></div>
            </div>
            <div class="row-fluid">
                <div class="span4 search-bloc">
                    <div class="btn ng-isolate-scope" id="delete-button" i18n="" key="'popup.button.cancel'">Undo</div>
                </div>
            </div>
        </div>

    </div>
</div>

<div id="field-hide">
    <input type="hidden" name="module_settings-key" value="{{pollid}}">
	<input type="hidden" name="current_preview" value="{{poll.preview}}">
    <input type="hidden" id="geofenceLocation" name="geofenceLocation" value="{{poll.geofenceLocation}}">
</div>